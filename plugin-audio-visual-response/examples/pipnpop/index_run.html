<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="../src/index.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css">
  <style>
    .circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: absolute;
      transition: background-color 0.1s;
    }
    .grid-container {
      position: relative;
      width: 600px;
      height: 600px;
      margin: 0 auto;
      border: 2px solid #ccc;
    }
    .pip-pop-stimulus {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 80vh;
    }
  </style>
</head>

<body></body>
<script>
  const jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData('json');
    }
  });

  let timeline = [];

  var preload = {
    type: jsPsychPreload,
    auto_preload: true
  };
  timeline.push(preload);

  // Instructions
  var instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div style="font-size:20px; line-height:1.8; max-width:800px; margin:0 auto;">
        <h2>Pip and Pop Experiment</h2>
        <p>In this experiment, you will see a grid of colored circles that change colors over time.</p>
        <p>Sometimes, a brief sound (a "pip") will play at the same time as one of the circles changes color.</p>
        <p>Your task is to identify <strong>which circle changed color when you heard the sound</strong>.</p>
        <p>Click on the circle that you think changed when the sound played.</p>
        <p>If you didn't hear a sound, or if no circle changed with the sound, click "No synchronous change".</p>
        <p><strong>Pay attention!</strong> The changes happen quickly.</p>
        <p>Press "Start Experiment" when you're ready to begin.</p>
      </div>
    `,
    choices: ['Start Experiment'],
  };
  timeline.push(instructions);

  // Global variables for the current trial
  let currentTrialData = {};
  let trialStartTime = 0;
  let responseGiven = false;

  // Global selectCircle function
  function selectCircle(circleId) {
    if (responseGiven) return;
    responseGiven = true;
    
    // Record the response
    const correct = (circleId === currentTrialData.targetPos) || 
                   (circleId === -1 && currentTrialData.targetPos === -1);
    
    // End the trial with response data
    jsPsych.finishTrial({
      response: circleId,
      target_position: currentTrialData.targetPos,
      sound_played: currentTrialData.soundPlayed,
      correct: correct,
      rt: Date.now() - trialStartTime
    });
  }

  // Generate pip and pop trials
  function createPipPopStimulus(targetPosition, withSound = true) {
    // Store trial data globally
    currentTrialData = {
      targetPos: targetPosition,
      soundPlayed: withSound
    };
    responseGiven = false;
    trialStartTime = Date.now();

    // Create a 4x4 grid of circles
    const gridSize = 4;
    const circlePositions = [];
    
    for (let row = 0; row < gridSize; row++) {
      for (let col = 0; col < gridSize; col++) {
        circlePositions.push({
          x: 50 + col * 130,
          y: 50 + row * 130,
          id: row * gridSize + col
        });
      }
    }

    // Generate initial colors (green circles)
    const initialColors = circlePositions.map(() => '#4CAF50');

    const circlesHTML = circlePositions.map((pos, index) => {
      return `<div class="circle" id="circle-${pos.id}" 
                style="left:${pos.x}px; top:${pos.y}px; background-color:${initialColors[index]};"
                onclick="selectCircle(${pos.id})"></div>`;
    }).join('');

    // Set up the color change and sound timing
    setTimeout(() => {
      if (targetPosition !== -1) {
        const targetCircle = document.getElementById('circle-' + targetPosition);
        if (targetCircle) {
          targetCircle.style.backgroundColor = '#F44336';
        }
      }
      
      // Play sound if this is a sound trial
      if (withSound) {
        const audio = new Audio('pip.wav');
        audio.play().catch(e => console.log('Audio play failed:', e));
      }
    }, Math.random() * 1000 + 500);

    return `
      <div class="pip-pop-stimulus">
        <div class="grid-container">
          ${circlesHTML}
        </div>
      </div>
      <div style="text-align:center; margin-top:30px;">
        <button id="no-change-btn" onclick="selectCircle(-1)" 
                style="padding:10px 20px; font-size:16px; background-color:#666; color:white; border:none; border-radius:5px; cursor:pointer;">
          No synchronous change
        </button>
      </div>
    `;
  }

  // Create trials with different conditions
  const trials = [];
  
  // Sound + visual change trials (synchronous)
  for (let i = 0; i < 8; i++) {
    const targetPos = Math.floor(Math.random() * 16);
    trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: () => createPipPopStimulus(targetPos, true),
      choices: "NO_KEYS",
      trial_duration: 5000,
      data: {
        trial_type: 'pip-pop',
        condition: 'synchronous',
        target_position: targetPos
      }
    });
  }
  
  // Sound only trials (no visual change at sound time)
  for (let i = 0; i < 4; i++) {
    trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: () => createPipPopStimulus(-1, true),
      choices: "NO_KEYS", 
      trial_duration: 5000,
      data: {
        trial_type: 'pip-pop',
        condition: 'sound-only',
        target_position: -1
      }
    });
  }
  
  // Visual change only trials (no sound)
  for (let i = 0; i < 4; i++) {
    const targetPos = Math.floor(Math.random() * 16);
    trials.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: () => createPipPopStimulus(targetPos, false),
      choices: "NO_KEYS",
      trial_duration: 5000,
      data: {
        trial_type: 'pip-pop',
        condition: 'visual-only',
        target_position: targetPos
      }
    });
  }

  // Shuffle trials
  trials.sort(() => Math.random() - 0.5);
  timeline.push(...trials);

  // Debrief
  var debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div style="font-size:20px; line-height:1.8; max-width:600px; margin:0 auto;">
        <h2>Experiment Complete!</h2>
        <p>Thank you for participating in the pip and pop experiment.</p>
        <p>This experiment demonstrates how sounds can make visual changes more noticeable - 
           the "pop out" effect when audio and visual stimuli are synchronized.</p>
        <p>Your data has been recorded. Click "Finish" to see your results.</p>
      </div>
    `,
    choices: ['Finish'],
  };
  timeline.push(debrief);

  jsPsych.run(timeline);
</script>
</html>
